name: Java CI/CD with Gradle & ECR & EC2 (OIDC)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

# 전역 권한 설정: OIDC 토큰 발급을 위해 id-token: write가 반드시 필요합니다.
permissions:
  id-token: write
  contents: read

jobs:
  # =========================================================
  # JOB 1: 빌드 및 ECR 푸시 (CI 단계)
  # =========================================================
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        run: ./gradlew clean bootJar

      # [수정] AWS 자격 증명 (OIDC 방식)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ACCOUNT_ID }}
          aws-region: ap-northeast-2

      # [수정] Docker Hub 로그인 대신 Amazon ECR 로그인
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # [수정] 빌드 및 ECR로 푸시
      - name: Build and Push to ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/my-server-app:latest
            ${{ steps.login-ecr.outputs.registry }}/my-server-app:${{ github.sha }}

  # =========================================================
  # JOB 2: AWS EC2 배포 (CD 단계)
  # =========================================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      # [수정] 배포 단계에서도 OIDC 인증을 통해 SSM 권한을 얻습니다.
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ACCOUNT_ID }}
          aws-region: ap-northeast-2

      - name: Deploy to EC2 via SSM
        uses: aws-actions/aws-ssm-send-command@v2
        with:
          aws-region: ap-northeast-2
          instance-ids: ${{ secrets.EC2_INSTANCE_ID }}
          command: |
            cd /home/ubuntu/cicd
            echo "${{ secrets.ENV_PROPERTIES }}" > .env
            docker-compose pull
            docker-compose down
            docker-compose up -d
            docker image prune -f